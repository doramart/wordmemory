import{r as e}from"./rolldown-runtime-K98o8HXg.js";import{A as t,G as n,J as r,K as i,M as a,O as ee,Q as o,S as te,V as ne,W as s,X as c,Y as l,Z as u,_ as re,at as d,c as ie,ct as ae,et as f,f as oe,h as se,it as p,j as ce,q as m,s as le,st as ue,t as de,v as h,x as fe,y as g,z as pe}from"./vue-qqQgwo1J.js";import{t as _}from"./vendor-BZARPbSw.js";import"./vant-BwjjKKVX.js";import{t as v}from"./index-DngR5WJL.js";import{i as y,r as b,t as x}from"./wordmemory-UTo84tZV.js";var S=e(_()),me={class:`word-manage`},he={class:`content-container`},ge={class:`stats-card`},_e={class:`stats-info`},ve={class:`stats-value`},ye={class:`stats-tags`},be={class:`upload-wrapper`},xe={class:`upload-placeholder`},Se={class:`ai-image-actions`},Ce={class:`form-actions`},we={class:`batch-card`},Te={class:`batch-header`},C={key:0,class:`batch-feedback`},w={class:`prompt-dialog`},T={class:`cropper-container-wrapper`},E={class:`cropper-nav`},D={class:`cropper-area`},O=[`src`],k=v({__name:`WordManage`,setup(e){let _=d([]),v=d(!1),k=d(!1),A=d(!1),j=d(``),M=d(``),N=d([]),P=d(!1),F=d(null),I=d(null),L=d(``),R=d(null),z=d(!1),B=d(!1),V=d(!1),H=d(!1),U=d(!1),W=d(``),G=d(`生成图片`),K=d(!1),Ee=[{text:`自动生图`,id:`auto`},{text:`提示词生图`,id:`custom`}],q=d({word:``,phonetic:``,meaning:``,example:``,imageUrl:``}),J=async()=>{try{_.value=(await y.getAll()).data||[]}catch(e){console.error(`Failed to load words:`,e),h(`加载单词失败`)}},De=async()=>{if(q.value.word)try{k.value=!0;let{data:e}=await y.generateDetails(q.value.word);q.value.phonetic=e?.phonetic||``,q.value.meaning=e?.meaning||``,q.value.example=e?.example||``}catch(e){console.error(`Failed to generate details:`,e),h(e.response?.data?.error||`生成失败，请稍后再试`)}finally{k.value=!1}},Oe=async()=>{try{v.value=!0,await y.create(q.value),q.value={word:``,phonetic:``,meaning:``,example:``,imageUrl:``},N.value=[],W.value=``,await J(),g(`单词添加成功`)}catch(e){console.error(`Failed to add word:`,e),e.response?.data?.message===`单词已存在`?h(`该单词已存在`):h(e.response?.data?.message||`添加单词失败`)}finally{v.value=!1}},ke=e=>!e||!e.type?.startsWith(`image/`)?`请选择图片文件`:e.size>10*1024*1024?`图片大小不能超过 10MB`:``,Ae=async e=>{$();let t=e?.file||e,n=ke(t);if(n){h(n);return}R.value=t,L.value=URL.createObjectURL(t),P.value=!0,await c();let r=F.value;r&&r.complete?Y():r.onload=Y},Y=()=>{F.value&&(I.value?.destroy(),I.value=new S.default(F.value,{viewMode:1,dragMode:`move`,autoCropArea:.8,restore:!1,guides:!0,center:!0,highlight:!1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!1}))},X=()=>(q.value.imageUrl=``,N.value=[],!0),Z=e=>{if(!e){h(`未获取到图片地址`);return}q.value.imageUrl=e,N.value=[{url:e,status:`done`,isImage:!0}]},je=async()=>{if(q.value.word)try{V.value=!0;let{data:e}=await x.generateByText({word:q.value.word,meaning:q.value.meaning});Z(e?.imageUrl),g(`图片已生成并上传`)}catch(e){console.error(`auto generate fail:`,e),h(e.response?.data?.error||e.response?.data?.message||`自动生成失败，请稍后再试`)}finally{V.value=!1}},Me=()=>{if(!q.value.word){h(`请先填写单词`);return}W.value,U.value=!0},Ne=async()=>{if(!W.value.trim()){h(`请先填写提示词`);return}try{H.value=!0,G.value=`AI 优化提示词中...`;let{data:e}=await x.generateByCustom({word:q.value.word,meaning:q.value.meaning,prompt:W.value});Z(e?.imageUrl),U.value=!1,g(`图片已生成并上传`)}catch(e){console.error(`custom generate fail:`,e),h(e.response?.data?.error||e.response?.data?.message||`生成失败，请稍后再试`)}finally{H.value=!1,G.value=`生成图片`}},Pe=e=>{e.id===`auto`?je():e.id===`custom`&&Me()},Q=()=>{P.value=!1},$=()=>{I.value?.destroy(),I.value=null,L.value&&URL.revokeObjectURL(L.value),L.value=``,R.value=null,z.value=!1},Fe=async()=>{if(!I.value||!R.value)return;let e=I.value.getCropperSelection?.();try{z.value=!0;let t=await e?.$toCanvas?.({width:800,height:800,beforeDraw:e=>{e.imageSmoothingQuality=`high`}})||I.value.getCroppedCanvas({width:800,height:800,imageSmoothingQuality:`high`});if(!t)throw Error(`无法生成裁剪区域`);let n=await new Promise((e,n)=>{t.toBlob(t=>{t?e(t):n(Error(`裁剪失败`))},R.value.type||`image/jpeg`,.92)}),r=new File([n],R.value.name,{type:n.type});B.value=!0,N.value.length>0&&(N.value[0].status=`uploading`,N.value[0].message=`上传中...`);let i=(await b.uploadImage(r))?.data||{},a=i.url||i.data?.url||``;q.value.imageUrl=a,N.value=a?[{url:a,status:`done`,isImage:!0}]:[],g(`图片上传成功`),Q()}catch(e){console.error(`upload fail:`,e),N.value.length>0&&(N.value[0].status=`failed`,N.value[0].message=`上传失败`),h(e.response?.data?.details||e.message||`上传失败`)}finally{z.value=!1,B.value=!1}},Ie=async e=>{try{M.value=``,j.value=``,A.value=!0;let t=(await y.importFromImage(e.file)).data||{};j.value=`已识别 ${t.total||0} 项，新增 ${t.inserted||0} 条，更新 ${t.updated||0} 条`,await J(),g(`批量导入完成`)}catch(e){console.error(`batch import fail:`,e),M.value=e.response?.data?.error||e.response?.data?.message||`批量导入失败`,h(M.value)}finally{A.value=!1}},Le=()=>{h(`图片大小不能超过 10MB`)},Re=()=>{h(`图片大小不能超过 10MB`)};return o(()=>{J()}),u(()=>{$()}),(e,o)=>{let c=re,u=a,d=t,h=fe,g=de,y=le,b=se,x=te,S=ce,I=ie,R=oe,J=ee;return f(),m(`div`,me,[s(`div`,he,[s(`div`,ge,[s(`div`,_e,[o[11]||=s(`div`,{class:`stats-label`},`当前词库`,-1),s(`div`,ve,[r(ae(_.value.length)+` `,1),o[10]||=s(`span`,{class:`stats-unit`},`个`,-1)])]),s(`div`,ye,[l(c,{color:`#e8f3ff`,"text-color":`#1989fa`,round:``},{default:p(()=>[...o[12]||=[r(`AI 智能补全`,-1)]]),_:1}),l(c,{color:`#fff8e6`,"text-color":`#ff976a`,round:``},{default:p(()=>[...o[13]||=[r(`批量导入`,-1)]]),_:1})])]),o[21]||=s(`div`,{class:`section-title`},`添加新单词`,-1),l(x,{onSubmit:Oe,class:`add-form`},{default:p(()=>[l(b,{class:`add-word-panel`,inset:``},{default:p(()=>[l(h,{modelValue:q.value.word,"onUpdate:modelValue":o[0]||=e=>q.value.word=e,name:`word`,label:`单词`,placeholder:`输入英文单词`,rules:[{required:!0,message:`请输入单词`}],clearable:``},{button:p(()=>[l(d,{size:`small`,type:`primary`,plain:``,hairline:``,round:``,loading:k.value,disabled:!q.value.word,onClick:ne(De,[`stop`,`prevent`])},{default:p(()=>[l(u,{name:`magic-wand`,class:`mr-1`}),o[14]||=r(` 智能补全 `,-1)]),_:1},8,[`loading`,`disabled`])]),_:1},8,[`modelValue`]),l(h,{modelValue:q.value.phonetic,"onUpdate:modelValue":o[1]||=e=>q.value.phonetic=e,name:`phonetic`,label:`音标`,placeholder:`例: /həˈləʊ/`},null,8,[`modelValue`]),l(h,{modelValue:q.value.meaning,"onUpdate:modelValue":o[2]||=e=>q.value.meaning=e,name:`meaning`,label:`释义`,placeholder:`中文释义`,type:`textarea`,autosize:``,rows:`1`},null,8,[`modelValue`]),l(h,{modelValue:q.value.example,"onUpdate:modelValue":o[3]||=e=>q.value.example=e,name:`example`,label:`例句`,type:`textarea`,rows:`2`,autosize:``,placeholder:`例句（可选）`},null,8,[`modelValue`]),l(h,{label:`配图`,class:`upload-field`},{input:p(()=>[s(`div`,be,[l(g,{modelValue:N.value,"onUpdate:modelValue":o[4]||=e=>N.value=e,"max-count":1,accept:`image/*`,"after-read":Ae,"before-delete":X,"max-size":10*1024*1024,capture:`camera`,onOversize:Re,class:`custom-uploader`},{default:p(()=>[s(`div`,xe,[l(u,{name:`photograph`,size:`24`,color:`#dcdee0`}),o[15]||=s(`span`,{class:`text`},`上传图片`,-1)])]),_:1},8,[`modelValue`]),s(`div`,Se,[l(y,{show:K.value,"onUpdate:show":o[5]||=e=>K.value=e,actions:Ee,placement:`bottom`,onSelect:Pe},{reference:p(()=>[l(d,{size:`small`,type:`primary`,plain:``,round:``,icon:`magic-wand`,loading:V.value||H.value},{default:p(()=>[...o[16]||=[r(` AI 生图 `,-1)]]),_:1},8,[`loading`])]),_:1},8,[`show`])])])]),_:1})]),_:1}),s(`div`,Ce,[l(d,{type:`primary`,round:``,block:``,"native-type":`submit`,loading:v.value,color:`linear-gradient(to right, #1989fa, #39b9f5)`,shadow:``},{default:p(()=>[...o[17]||=[r(` 确认添加 `,-1)]]),_:1},8,[`loading`])])]),_:1}),o[22]||=s(`div`,{class:`section-title`},`批量导入`,-1),s(`div`,we,[s(`div`,Te,[o[18]||=s(`div`,{class:`batch-text`},[s(`h3`,null,`图片识别导入`),s(`p`,null,`上传单词表图片，AI 自动识别入库`)],-1),l(u,{name:`scan`,size:`32`,color:`#1989fa`,style:{opacity:`0.2`}})]),l(g,{"max-count":1,accept:`image/*`,"after-read":Ie,disabled:A.value,"max-size":10*1024*1024,"preview-image":!1,capture:`camera`,class:`batch-uploader-full`,onOversize:Le},{default:p(()=>[s(`div`,{class:ue([`batch-upload-area`,{importing:A.value}])},[A.value?(f(),n(S,{key:0,type:`spinner`,color:`#1989fa`,vertical:``},{default:p(()=>[...o[19]||=[r(`识别中...`,-1)]]),_:1})):(f(),n(d,{key:1,icon:`plus`,type:`primary`,plain:``,block:``,round:``,dashed:``},{default:p(()=>[...o[20]||=[r(`选择图片`,-1)]]),_:1}))],2)]),_:1},8,[`disabled`]),l(pe,{name:`van-fade`},{default:p(()=>[j.value||M.value?(f(),m(`div`,C,[j.value?(f(),n(I,{key:0,"left-icon":`passed`,text:j.value,color:`#07c160`,background:`#e8f8f0`,wrapable:``},null,8,[`text`])):i(``,!0),M.value?(f(),n(I,{key:1,"left-icon":`warning-o`,text:M.value,color:`#ee0a24`,background:`#ffe1e1`,wrapable:``},null,8,[`text`])):i(``,!0)])):i(``,!0)]),_:1})])]),l(R,{show:U.value,"onUpdate:show":o[7]||=e=>U.value=e,title:`自定义生图`,"show-cancel-button":``,"confirm-button-loading":H.value,"confirm-button-text":H.value?G.value:`生成图片`,"cancel-button-text":`取消`,"close-on-click-overlay":!H.value,onConfirm:Ne,onClosed:o[8]||=e=>W.value=``},{default:p(()=>[s(`div`,w,[o[23]||=s(`p`,{class:`prompt-tip`},` 根据你的灵感描述一个场景，系统会结合单词生成易记的插画。可用中文或英文，避免含有文字或敏感内容。 `,-1),l(h,{modelValue:W.value,"onUpdate:modelValue":o[6]||=e=>W.value=e,type:`textarea`,rows:`4`,autosize:``,maxlength:`100`,"show-word-limit":``,placeholder:`例如：把西兰花剥进鸡蛋壳里形成可爱的造型，柔和光线，简洁背景。`,border:!1},null,8,[`modelValue`])])]),_:1},8,[`show`,`confirm-button-loading`,`confirm-button-text`,`close-on-click-overlay`]),l(J,{show:P.value,"onUpdate:show":o[9]||=e=>P.value=e,position:`bottom`,teleport:`body`,style:{height:`100%`},class:`cropper-popup`,onClosed:$},{default:p(()=>[s(`div`,T,[s(`div`,E,[l(u,{name:`cross`,size:`24`,color:`#fff`,onClick:Q}),o[25]||=s(`span`,{class:`title`},`调整图片`,-1),l(d,{size:`small`,type:`primary`,onClick:Fe,loading:z.value||B.value},{default:p(()=>[...o[24]||=[r(`完成`,-1)]]),_:1},8,[`loading`])]),s(`div`,D,[s(`img`,{ref_key:`cropperImage`,ref:F,src:L.value,alt:``},null,8,O)])])]),_:1},8,[`show`])])}}},[[`__scopeId`,`data-v-ad55ac85`]]);export{k as default};